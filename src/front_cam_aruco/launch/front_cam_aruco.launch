<launch>
  <arg name="web_video_port" default="8088"/>
  <arg name="rosbridge_port" default="9091"/>
  <arg name="marker_length" default="0.03"/>  <!-- 3 cm -->
  <arg name="aruco_dict" default="DICT_4X4_50"/>
  <arg name="main_marker_id" default="0"/>

  <group ns="front_cam">
    <!-- Option B: KHÔNG dùng image_proc. Detect trực tiếp trên /usb_camera/image_raw -->
    <node pkg="front_cam_aruco" type="front_aruco_detect.py" name="front_aruco_detect" output="screen">
      <param name="camera_frame" value="front_cam/usb_cam_link"/>
      <param name="image_topic" value="/usb_camera/image_raw"/>
      <param name="camera_info_topic" value="/usb_camera/camera_info"/>
      <param name="marker_length" value="$(arg marker_length)"/>
      <param name="aruco_dictionary" value="$(arg aruco_dict)"/>
      <param name="publish_rate" value="20"/>
      <param name="debug_draw" value="true"/>
      <param name="min_detect_interval" value="0.0"/>
      <!-- Fallback intrinsics khi camera_info không có/không hợp lệ -->
      <param name="fallback_fov_deg" value="62.0"/>
    </node>

    <!-- Tính góc từ TF -->
    <node pkg="front_cam_aruco" type="calculate_front_angle.py" name="calculate_front_angle" output="screen">
      <param name="marker_id" value="$(arg main_marker_id)"/>
      <param name="camera_frame" value="front_cam/usb_cam_link"/>
      <param name="publish_rate" value="20"/>
    </node>

    <!-- Overlay (vẽ trục) trên ảnh RAW -->
    <node pkg="front_cam_aruco" type="aruco_front_overlay.py" name="aruco_front_overlay" output="screen">
      <param name="camera_frame" value="front_cam/usb_cam_link"/>
      <param name="marker_ids" value="[0,1,2,3]"/>
      <param name="axis_len" value="0.05"/>
      <param name="publish_rate" value="15"/>
      <param name="image_topic" value="/usb_camera/image_raw"/>
      <param name="camera_info_topic" value="/usb_camera/camera_info"/>
    </node>

    <!-- Web video server riêng (tránh 8080 của PiCam) -->
    <node pkg="web_video_server" type="web_video_server" name="web_video_server" output="screen">
      <param name="port" value="$(arg web_video_port)"/>
    </node>

    <!-- Rosbridge riêng -->
    <node pkg="rosbridge_server" type="rosbridge_websocket" name="rosbridge_websocket" output="screen">
      <param name="port" value="$(arg rosbridge_port)"/>
    </node>
  </group>

  <!-- Static TF: camera gắn phía trước -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="front_cam_static_tf"
        args="0.08 0 0 -1.57079632679 0 -1.57079632679 base_link front_cam/usb_cam_link" />
</launch>